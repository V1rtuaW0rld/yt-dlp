<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>WebVideoDownLoader</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        form { margin-bottom: 20px; }
        input[type="text"] { width: 400px; padding: 8px; }
        button { padding: 8px 16px; background: #007bff; color: white; border: none; cursor: pointer; }
        #output { border: 1px solid #ccc; padding: 10px; height: 400px; overflow-y: auto; background: #f5f5f5; white-space: pre-wrap; font-family: monospace; }
        #video-table { width: 75%; margin: 20px 0; border-collapse: collapse; border: 2px solid #333; }
        #video-table td { padding: 10px; border: 1px solid #333; vertical-align: middle; }
        #video-table td:first-child { width: auto; }
        #video-table td:nth-child(2) { width: 200px; }
        #video-title { font-size: 1.2em; font-weight: bold; }
        #progress-container { position: relative; width: 100%; }
        #progress { width: 100%; height: 40px; -webkit-appearance: none; appearance: none; background: #e0e0e0; border-radius: 5px; overflow: hidden; }
        #progress::-webkit-progress-bar { background: #e0e0e0; }
        #progress::-webkit-progress-value { background: #007bff; transition: width 0.3s ease; }
        #progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-weight: bold; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7); font-size: 1.1em; }
    </style>
</head>
<body>
    <h1>WebVideoDownLoader</h1>
    <form id="download-form" action="/download" method="POST">
        <input type="text" id="url" name="url" placeholder="https://www.youtube.com/watch?v=..." required>
        <button type="submit">Lancer Téléchargement(s)</button>
    </form>

    <table id="video-table">
        <tbody id="video-table-body">
            <tr><td colspan="2">En attente de tâches...</td></tr>
        </tbody>
    </table>

    <h2>Sortie en direct :</h2>
    <div id="output">Prêt à télécharger...</div>

    <script>
        const form = document.getElementById('download-form');
        const output = document.getElementById('output');
        const tableBody = document.getElementById('video-table-body');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            output.textContent = 'Démarrage...\n';
            const url = document.getElementById('url').value;
            const res = await fetch('/download', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `url=${encodeURIComponent(url)}`
            });
            if (res.ok) {
                output.textContent += 'Commande(s) lancée(s) !\n';
            } else {
                output.textContent += 'Erreur lors du démarrage.\n';
            }
        });

        const eventSource = new EventSource('/stream');
        eventSource.onmessage = (event) => {
            if (event.data) {
                const match = event.data.match(/\[([^\]]+)\]\s*(.+)/); // Extraire task_id et data
                if (match) {
                    const taskId = match[1];
                    const data = match[2];
                    console.log(`TaskId: "${taskId}", Data: "${data}"`);
                    let row = document.querySelector(`tr[data-task-id="${taskId}"]`);
                    if (!row) {
                        row = document.createElement('tr');
                        row.setAttribute('data-task-id', taskId);
                        row.innerHTML = `<td id="video-title-${taskId}">En attente du titre...</td><td><div id="progress-container-${taskId}"><progress id="progress-${taskId}" value="0" max="100"></progress><span id="progress-text-${taskId}">0%</span></div></td>`;
                        tableBody.appendChild(row);
                    }
                    if (data.startsWith('Titre récupéré :')) {
                        const title = data.replace('Titre récupéré :', '').trim();
                        const titleElement = document.getElementById(`video-title-${taskId}`);
                        if (titleElement) titleElement.textContent = title;
                        else console.error(`Élément non trouvé pour title-${taskId}`);
                    } else if (data.startsWith('Progress:')) {
                        const percentage = parseFloat(data.replace('Progress:', '').trim());
                        const progress = document.getElementById(`progress-${taskId}`);
                        const progressText = document.getElementById(`progress-text-${taskId}`);
                        if (progress && progressText) {
                            progress.value = percentage;
                            progressText.textContent = `${percentage.toFixed(1)}%`;
                        } else console.error(`Progression non trouvée pour ${taskId}`);
                    } else {
                        output.textContent += `${event.data}\n`;
                        output.scrollTop = output.scrollHeight;
                    }
                } else {
                    output.textContent += `${event.data}\n`;
                    output.scrollTop = output.scrollHeight;
                }
            }
        };
        eventSource.onerror = () => {
            output.textContent += 'Erreur de connexion au stream.\n';
            eventSource.close();
        };
    </script>
</body>
</html>