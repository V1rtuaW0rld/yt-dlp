<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Téléchargeur YouTube</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        form { margin-bottom: 20px; }
        input[type="text"] { width: 400px; padding: 8px; }
        button { padding: 8px 16px; background: #007bff; color: white; border: none; cursor: pointer; }
        #output { 
            border: 1px solid #ccc; padding: 10px; height: 400px; 
            overflow-y: auto; background: #f5f5f5; white-space: pre-wrap; 
            font-family: monospace; 
        }
        #video-table {
            width: 75%; /* Utilise 3/4 de la page */
            margin: 20px 0;
            border-collapse: collapse;
            border: 2px solid #333; /* Contours visibles */
        }
        #video-table td {
            padding: 10px;
            border: 1px solid #333; /* Contours dans les cellules */
            vertical-align: middle; /* Centrage vertical */
        }
        #video-table td:first-child { /* Colonne de gauche (titre) */
            width: auto; /* S'adapte au contenu */
        }
        #video-table td:last-child { /* Colonne de droite (barre) */
            width: 200px; /* Fixe la largeur à 200px */
        }
        #video-title {
            font-size: 1.2em;
            font-weight: bold;
        }
        #progress-container {
            position: relative;
            width: 100%; /* Pleine largeur de la cellule (200px) */
        }
        #progress {
            width: 100%; /* S'étend sur 200px */
            height: 40px; /* Barre épaisse */
            -webkit-appearance: none;
            appearance: none;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
        }
        #progress::-webkit-progress-bar {
            background: #e0e0e0;
        }
        #progress::-webkit-progress-value {
            background: #007bff;
            transition: width 0.3s ease; /* Animation fluide */
        }
        #progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7); /* Ombre pour lisibilité */
            font-size: 1.1em;
        }
    </style>
</head>
<body>
    <h1>Téléchargeur YouTube</h1>
    <form id="download-form" action="/download" method="POST">
        <input type="text" id="url" name="url" placeholder="https://www.youtube.com/watch?v=..." required>
        <button type="submit">Lancer Téléchargement</button>
    </form>

    <table id="video-table">
        <tr>
            <td id="video-title">En attente du titre...</td>
            <td>
                <div id="progress-container">
                    <progress id="progress" value="0" max="100"></progress>
                    <span id="progress-text">0%</span>
                </div>
            </td>
        </tr>
    </table>

    <h2>Sortie en direct :</h2>
    <div id="output">Prêt à télécharger...</div>

    <script>
        const form = document.getElementById('download-form');
        const output = document.getElementById('output');
        const videoTitle = document.getElementById('video-title');
        const progressBar = document.getElementById('progress');
        const progressText = document.getElementById('progress-text');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            output.textContent = 'Démarrage...\n';
            videoTitle.textContent = 'Récupération du titre...';
            progressBar.value = 0;
            progressText.textContent = '0%';
            const url = document.getElementById('url').value;
            const res = await fetch('/download', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `url=${encodeURIComponent(url)}`
            });
            if (res.ok) {
                output.textContent += 'Commande lancée !\n';
            } else {
                output.textContent += 'Erreur lors du démarrage.\n';
                videoTitle.textContent = 'Erreur lors de la récupération du titre';
            }
        });

        // SSE pour afficher la sortie, le titre et la progression
        const eventSource = new EventSource('/stream');
        eventSource.onmessage = (event) => {
            if (event.data) {
                if (event.data.startsWith('title: ')) {
                    videoTitle.textContent = event.data.replace('title: ', '');
                } else if (event.data.startsWith('progress: ')) {
                    const percentage = parseFloat(event.data.replace('progress: ', ''));
                    progressBar.value = percentage;
                    progressText.textContent = `${percentage.toFixed(1)}%`;
                } else {
                    output.textContent += event.data + '\n'; // Forcer les retours à la ligne
                    output.scrollTop = output.scrollHeight; // Défilement automatique
                }
            }
        };
        eventSource.onerror = () => {
            output.textContent += 'Erreur de connexion au stream.\n';
            eventSource.close();
        };
    </script>
</body>
</html>